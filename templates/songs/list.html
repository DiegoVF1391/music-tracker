{% extends 'base.html' %}
{% block title %}Canciones{% endblock %}
{% block content %}
<h1 class="mb-3">üéµ Canciones</h1>
<a href="/songs/add" class="btn btn-primary mb-3">+ Nueva canci√≥n</a>
<div class="table-responsive">
  <table class="table table-dark table-striped">
  <thead>
    <tr>
      <th>¬øEntra?</th>
      <th>Nombre</th>
      <th>Proyecto</th>
      <th>G√©nero</th>
      <th>Artista</th>
      <th>√Ålbum</th>
      <th>Estado</th>
      <th>Rating</th>
      <th>Direcci√≥n</th>
      <th>URL</th>
      <th>Fecha Terminar</th>
      <th>Fecha de Lanzamiento</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody>
    {% for song in songs %}
      <tr>
        <td><input type="checkbox" name="select[]" value="{{ song.id }}" {% if song.in_album %}checked{% endif %}></td>
        <td class="col-name">{{ song.name }}</td>
        <td class="col-project">{{ song.project_name }}</td>
        <td class="col-genre">{{ song.genre }}</td>
        <td class="col-artist" data-artist-id="{{ song.artist_id if song.artist_id is not none else '' }}">{{ song.artists.name if song.artists else '' }}</td>
        <td class="col-album" data-album-id="{{ song.album_id if song.album_id is not none else '' }}">{{ song.albums.name if song.albums else '' }}</td>
        <td class="col-status">{{ song.status }}</td>
        <td class="col-rating">{% if song.rating %}{% set r = song.rating|int %}{% for i in range(r) %}‚≠ê{% endfor %}{% endif %}</td>
        <td class="col-path">{{ song.path }}</td>
        <td class="col-url">{{ song.url }}</td>
        <td class="col-due_date">{{ song.due_date }}</td>
        <td class="col-release_date">{{ song.release_date }}</td>
        <td class="col-actions">
          <button type="button" class="btn btn-sm btn-secondary btn-edit">Editar</button>
          <button type="button" class="btn btn-sm btn-success btn-save d-none">
            <span class="spinner-border spinner-border-sm save-spinner d-none me-1" role="status" aria-hidden="true"></span>
            <span class="save-text">Guardar</span>
          </button>
          <button type="button" class="btn btn-sm btn-warning btn-cancel d-none">Cancelar</button>
          <a href="/songs/delete/{{ song.id }}" class="btn btn-danger btn-sm ms-1">Eliminar</a>
        </td>
      </tr>
    {% endfor %}
  </tbody>
  </table>
</div>
<!-- Toast container -->
<div aria-live="polite" aria-atomic="true" class="position-fixed top-0 end-0 p-3" style="z-index:1080">
  <div id="globalToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="globalToastBody"></div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>
<script>
// embed artists and albums for JS
const __ARTISTS = {{ artists|tojson|safe }};
const __ALBUMS = {{ albums|tojson|safe }};

document.addEventListener('DOMContentLoaded', function(){
  function showToast(message, type='success'){
    const toastEl = document.getElementById('globalToast');
    if(!toastEl) return;
    // normalize type
    const clsRemove = ['text-bg-success','text-bg-danger','text-bg-warning'];
    clsRemove.forEach(c => toastEl.classList.remove(c));
    const cls = type === 'success' ? 'text-bg-success' : (type === 'error' ? 'text-bg-danger' : 'text-bg-warning');
    toastEl.classList.add(cls);
    toastEl.querySelector('.toast-body').textContent = message;
    const bsToast = new bootstrap.Toast(toastEl);
    bsToast.show();
  }

  function toInput(cell, type){
    const val = cell.textContent.trim();
    let input = document.createElement('input');
    input.className = 'form-control form-control-sm';
    if(type === 'number'){
      input.type = 'number';
      input.value = val || '';
    } else if(type === 'date'){
      input.type = 'date';
      // try to parse date-like values
      input.value = val ? val : '';
  } else if(type === 'artist'){
      // create select populated with artists
      const select = document.createElement('select');
      select.className = 'form-select form-select-sm';
      const currentId = cell.getAttribute('data-artist-id') || '';
      // empty option
      const emptyOpt = document.createElement('option');
      emptyOpt.value = '';
      emptyOpt.textContent = '(ninguno)';
      select.appendChild(emptyOpt);
      __ARTISTS.forEach(function(a){
        const opt = document.createElement('option');
        opt.value = a.id;
        opt.textContent = a.name;
        if(String(a.id) === String(currentId)) opt.selected = true;
        select.appendChild(opt);
      });
      // if current name not in list, add a 'create new' option
      if(currentId === ''){
        const currentName = val;
        if(currentName){
          const createOpt = document.createElement('option');
          createOpt.value = 'new:' + currentName;
          createOpt.textContent = 'Crear: ' + currentName;
          createOpt.selected = true;
          select.appendChild(createOpt);
        }
      }
      return select;
  } else if(type === 'album'){
      const select = document.createElement('select');
      select.className = 'form-select form-select-sm';
      const currentId = cell.getAttribute('data-album-id') || '';
      const emptyOpt = document.createElement('option');
      emptyOpt.value = '';
      emptyOpt.textContent = '(ninguno)';
      select.appendChild(emptyOpt);
      __ALBUMS.forEach(function(a){
        const opt = document.createElement('option');
        opt.value = a.id;
        opt.textContent = a.name;
        if(String(a.id) === String(currentId)) opt.selected = true;
        select.appendChild(opt);
      });
      if(currentId === ''){
        const currentName = val;
        if(currentName){
          const createOpt = document.createElement('option');
          createOpt.value = 'new:' + currentName;
          createOpt.textContent = 'Crear: ' + currentName;
          createOpt.selected = true;
          select.appendChild(createOpt);
        }
      }
      return select;
    } else if(type === 'status'){
      const select = document.createElement('select');
      select.className = 'form-select form-select-sm';
      const options = ['idea','producci√≥n','falta letra','grabar voz','mezcla','masterizaci√≥n','terminada','en plataformas'];
      const current = val || '';
      const emptyOpt = document.createElement('option');
      emptyOpt.value = '';
      emptyOpt.textContent = '(ninguno)';
      select.appendChild(emptyOpt);
      options.forEach(function(optVal){
        const opt = document.createElement('option');
        opt.value = optVal;
        opt.textContent = optVal;
        if(optVal === current) opt.selected = true;
        select.appendChild(opt);
      });
      return select;
    } else if(type === 'rating'){
      const select = document.createElement('select');
      select.className = 'form-select form-select-sm';
      const cur = parseInt(val) || 0;
      /*const emptyOpt = document.createElement('option');
      emptyOpt.value = '';
      emptyOpt.textContent = '(sin rating)';
      select.appendChild(emptyOpt);*/
      for(let r=1;r<=5;r++){
        const opt = document.createElement('option');
        opt.value = String(r);
        opt.textContent = '‚≠ê'.repeat(r) + ' (' + r + ')';
        if(r === cur) opt.selected = true;
        select.appendChild(opt);
      }
      return select;
    } else {
      input.type = 'text';
      input.value = val || '';
    }
    return input;
  }

  function enterEdit(row){
    // prevent double
    if(row.dataset.editing === '1') return;
    row.dataset.editing = '1';
    // store originals
    row._originals = [];
  // cells mapping (skip checkbox at 0 and actions at last)
  const types = {1:'text',2:'text',3:'text',4:'artist',5:'album',6:'status',7:'rating',8:'text',9:'text',10:'date',11:'date'};
    for(let i=1;i<=11;i++){
      const cell = row.cells[i];
      row._originals.push(cell.innerHTML);
      const input = toInput(cell, types[i]);
      cell.innerHTML = '';
      cell.appendChild(input);
    }
    // toggle buttons
    const editBtn = row.querySelector('.btn-edit');
    const saveBtn = row.querySelector('.btn-save');
    const cancelBtn = row.querySelector('.btn-cancel');
    editBtn.classList.add('d-none');
    saveBtn.classList.remove('d-none');
    cancelBtn.classList.remove('d-none');
    // ensure buttons are enabled (they may have been left disabled)
    if(saveBtn) saveBtn.disabled = false;
    if(cancelBtn) cancelBtn.disabled = false;
  }

  function cancelEdit(row){
    if(!row.dataset.editing) return;
    // restore
    for(let i=1;i<=11;i++){
      const cell = row.cells[i];
      cell.innerHTML = row._originals[i-1];
    }
    row.removeAttribute('data-editing');
    row._originals = null;
    const editBtn = row.querySelector('.btn-edit');
    const saveBtn = row.querySelector('.btn-save');
    const cancelBtn = row.querySelector('.btn-cancel');
    if(editBtn) editBtn.classList.remove('d-none');
    if(saveBtn) { saveBtn.classList.add('d-none'); saveBtn.disabled = false; }
    if(cancelBtn) { cancelBtn.classList.add('d-none'); cancelBtn.disabled = false; }
  }

  async function saveEdit(row){
    const id = row.querySelector('input[type="checkbox"]').value;
    const data = {};
    // in_album from checkbox at cell 0
    data.in_album = row.querySelector('input[type="checkbox"]').checked ? 1 : 0;
    // collect from inputs/selects
    const keys = ['name','project_name','genre','artist_id','album_id','status','rating','path','url','due_date','release_date'];
    for(let i=1;i<=11;i++){
      const cell = row.cells[i];
      const input = cell.querySelector('input, select');
      data[keys[i-1]] = input ? input.value : '';
    }

  // disable buttons and show spinner
  const saveBtn = row.querySelector('.btn-save');
  const cancelBtn = row.querySelector('.btn-cancel');
  if(saveBtn) { saveBtn.disabled = true; const spinner = saveBtn.querySelector('.save-spinner'); if(spinner) spinner.classList.remove('d-none'); }
  if(cancelBtn) cancelBtn.disabled = true;

    try{
      const res = await fetch('/songs/edit/' + id, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      });
      if(!res.ok){
        const text = await res.text();
        // hide spinner
        if(saveBtn){ const spinner = saveBtn.querySelector('.save-spinner'); if(spinner) spinner.classList.add('d-none'); }
        showToast('Error al guardar: ' + res.status + ' - ' + text, 'error');
        saveBtn.disabled = false; cancelBtn.disabled = false;
        return;
      }
  // on success, update the cells to new values
      const keysMap = ['name','project_name','genre','artist_id','album_id','status','rating','path','url','due_date','release_date'];
      for(let i=1;i<=11;i++){
        const cell = row.cells[i];
        const key = keysMap[i-1];
        const val = data[key];
        if(key === 'artist_id'){
          // set text to selected artist name and update data-artist-id
          const sel = cell.querySelector('select');
          if(sel){
            const selectedText = sel.options[sel.selectedIndex] ? sel.options[sel.selectedIndex].textContent : '';
            const selectedVal = sel.value || '';
            cell.textContent = selectedText || '';
            cell.setAttribute('data-artist-id', selectedVal);
          } else {
            cell.textContent = val || '';
            cell.setAttribute('data-artist-id', '');
          }
        } else if(key === 'album_id'){
          const sel = cell.querySelector('select');
          if(sel){
            const selectedText = sel.options[sel.selectedIndex] ? sel.options[sel.selectedIndex].textContent : '';
            const selectedVal = sel.value || '';
            cell.textContent = selectedText || '';
            cell.setAttribute('data-album-id', selectedVal);
          } else {
            cell.textContent = val || '';
            cell.setAttribute('data-album-id', '');
          }
        } else if(key === 'rating'){
          // display stars for rating
          const ratingVal = parseInt(data['rating']) || 0;
          cell.textContent = ratingVal > 0 ? '‚≠ê'.repeat(ratingVal) : '';
        } else {
          cell.textContent = val || '';
        }
  }
  // re-enable buttons (in case they were disabled) and switch UI back
  const editBtn = row.querySelector('.btn-edit');
  const saveBtn = row.querySelector('.btn-save');
  const cancelBtn = row.querySelector('.btn-cancel');
  if(saveBtn){ const spinner = saveBtn.querySelector('.save-spinner'); if(spinner) spinner.classList.add('d-none'); saveBtn.disabled = false; }
  if(cancelBtn) cancelBtn.disabled = false;
  showToast('Guardado correctamente', 'success');
  row.removeAttribute('data-editing');
  row._originals = null;
  if(editBtn) editBtn.classList.remove('d-none');
  if(saveBtn) saveBtn.classList.add('d-none');
  if(cancelBtn) cancelBtn.classList.add('d-none');
    }catch(err){
      if(saveBtn){ const spinner = saveBtn.querySelector('.save-spinner'); if(spinner) spinner.classList.add('d-none'); }
      showToast('Error al conectar: ' + err, 'error');
      saveBtn.disabled = false; cancelBtn.disabled = false;
    }
  }

  // attach events
  document.querySelectorAll('table tbody tr').forEach(function(row){
    const editBtn = row.querySelector('.btn-edit');
    const saveBtn = row.querySelector('.btn-save');
    const cancelBtn = row.querySelector('.btn-cancel');
    if(editBtn){
      editBtn.addEventListener('click', function(){ enterEdit(row); });
    }
    if(cancelBtn){
      cancelBtn.addEventListener('click', function(){ cancelEdit(row); });
    }
    if(saveBtn){
      saveBtn.addEventListener('click', function(){ saveEdit(row); });
    }
  });
});
</script>
{% endblock %}
